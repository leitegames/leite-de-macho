<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sirilo e o Leite de Macho - Ranking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-yellow: #ffde59;
            --secondary-yellow: #ffc300;
            --shadow-yellow: #c78f00;
            --text-dark: #3d2b00;
            --bg-dark: #141e30;
            --bg-light: #243b55;
            --ground: #27ae60;
            --border: #fff;
        }

        html, body {
            margin: 0; padding: 0; font-family: 'Fredoka One', cursive;
            width: 100%; height: 100%; overflow: hidden;
            background-color: #0c0c1e; display: flex;
            justify-content: center; align-items: center; touch-action: manipulation;
        }

        #game-container {
            width: 100%; height: 100%;
            max-width: 500px; max-height: 100vh;
            background: linear-gradient(to bottom, var(--bg-dark), var(--bg-light));
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            position: relative; overflow: hidden;
            border: 5px solid var(--border);
            border-bottom: 10px solid var(--ground);
            border-radius: 20px;
            display: flex; flex-direction: column;
        }
        
        #game-canvas { width: 100%; height: 100%; display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        /* --- Telas, Menus e Modais --- */
        .screen, .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box; z-index: 100;
            color: white; transition: opacity 0.3s, visibility 0.3s;
        }
        .screen.hidden, .modal-overlay.hidden { opacity: 0; visibility: hidden; }
        .screen { justify-content: flex-start; overflow-y: auto; }
        
        .modal-content {
            background: var(--bg-light); padding: 30px; border-radius: 20px; border: 3px solid var(--border);
            box-shadow: 0 5px 25px rgba(0,0,0,0.3); width: 90%; max-width: 350px;
        }
        .modal-content h2 { font-size: 28px; margin-top: 0; color: var(--primary-yellow); }
        .modal-content input {
            width: 100%; padding: 12px; margin: 15px 0; border-radius: 10px; border: 2px solid var(--border);
            background: rgba(0,0,0,0.2); color: white; font-family: 'Fredoka One', cursive; font-size: 18px;
            text-align: center;
        }
        
        .screen h1 {
            font-size: clamp(40px, 12vw, 60px); color: var(--primary-yellow);
            text-shadow: 4px 4px 0px var(--shadow-yellow), 0 0 30px var(--primary-yellow);
            margin-top: 20px; margin-bottom: 10px; animation: bounce-in 1s ease-out;
        }
        .screen h2 { font-size: clamp(30px, 8vw, 40px); margin-bottom: 20px; }
        .screen p { font-size: clamp(16px, 4vw, 22px); margin-bottom: 15px; max-width: 350px; }
        .screen .high-score, .screen .total-milk-display { 
            font-size: clamp(18px, 5vw, 24px); color: var(--primary-yellow); 
            margin: 5px 0 15px 0; text-shadow: 2px 2px 0 var(--shadow-yellow); 
        }

        /* --- Bot√µes --- */
        .screen button, .modal-content button {
            font-family: 'Fredoka One', cursive; padding: 15px 30px; 
            font-size: clamp(18px, 5vw, 24px);
            color: var(--text-dark); background: linear-gradient(180deg, var(--primary-yellow), var(--secondary-yellow));
            border: none; border-radius: 15px; border-bottom: 6px solid var(--shadow-yellow);
            cursor: pointer; transition: all 0.1s ease-in-out; margin-top: 10px;
        }
        .screen button:hover, .modal-content button:hover { filter: brightness(1.1); }
        .screen button:active, .modal-content button:active { transform: translateY(4px); border-bottom-width: 2px; }
        .screen button:disabled, .modal-content button:disabled { filter: brightness(0.7) grayscale(0.5); cursor: not-allowed; }
        
        .menu-selection { display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center; }
        .menu-selection button { width: 80%; max-width: 350px; display: flex; justify-content: center; align-items: center; gap: 15px;}
        .menu-selection button .icon { font-size: clamp(24px, 6vw, 30px); }
        #ranking-button { background: #e67e22; border-bottom-color: #d35400; color: white;}
        #upgrades-button { background: #2ecc71; border-bottom-color: #27ae60; color: white;}
        #choose-emoji-button { background: #9b59b6; border-bottom-color: #8e44ad; color: white;}
        .back-to-menu-button { margin-top: auto; padding-top: 20px; background: #7f8c8d; border-bottom-color: #606b6c; color: white;}
        
        /* --- Ranking --- */
        #ranking-list { list-style: none; width: 100%; max-width: 380px; padding: 0; margin-top: 20px; }
        #ranking-list li {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 10px;
            margin-bottom: 10px; font-size: 18px;
        }
        #ranking-list li .rank { font-weight: bold; color: var(--primary-yellow); min-width: 30px; }
        #ranking-list li .name { flex-grow: 1; text-align: left; margin-left: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #ranking-list li .score { font-weight: bold; }
        #ranking-list .loading { font-size: 20px; margin-top: 30px; }
        
        /* O resto do CSS permanece similar, com pequenas melhorias... */
        #game-container.shake { animation: screen-shake 0.2s; }
        @keyframes screen-shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, 5px); } }
        @keyframes bounce-in { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; }}
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <!-- Elementos do Jogo (HUD, Boss, etc.) -->
        <div id="ui-container" class="hidden">...</div>
        <!-- ... (o restante dos elementos do jogo como boss, etc. seriam colocados aqui) ... -->

        <!-- Telas de Menu -->
        <div id="main-menu" class="screen">
            <h1>Leite de Macho</h1>
            <p class="total-milk-display">Leite Total: 0</p>
            <div class="menu-selection">
                <button data-mode="infinite"><span class="icon">‚ôæÔ∏è</span>Modo Infinito</button>
                <button id="ranking-button"><span class="icon">üëë</span>Ranking Global</button>
                <button id="upgrades-button" disabled><span class="icon">üöÄ</span>Melhorias</button>
                <button id="choose-emoji-button"><span class="icon">üòÄ</span>Loja de Emoji</button>
            </div>
            <p class="high-score" style="margin-top: 20px;">Seu Recorde: 0</p>
        </div>

        <div id="ranking-screen" class="screen hidden">
            <h2>Ranking Global</h2>
            <ul id="ranking-list"><li class="loading">Carregando ranking...</li></ul>
            <button class="back-to-menu-button">Menu Principal</button>
        </div>
        
        <!-- Outras telas (Loja de Emoji, Fim de Jogo) aqui... -->
        <div id="emoji-select-screen" class="screen hidden">
             <h2>Loja de Personagens</h2>
             <p class="total-milk-display">Leite Total: 0</p>
             <div id="emoji-select-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; width: 100%; max-width: 400px; margin-bottom: 20px;"></div>
             <button class="back-to-menu-button">Menu Principal</button>
        </div>
        
        <div id="game-over-screen" class="screen hidden">
            <h1>Fim de Jogo!</h1>
            <p id="final-score"></p>
            <p class="high-score"></p>
            <button id="restart-button">Tentar Novamente</button>
            <button class="back-to-menu-button">Menu Principal</button>
        </div>
        
        <!-- Modal para Inserir Nome -->
        <div id="name-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Parab√©ns!</h2>
                <p>Voc√™ entrou no ranking! Digite seu nome para aparecer na lista.</p>
                <input type="text" id="player-name-input" placeholder="Seu Nome" maxlength="15">
                <button id="save-name-button">Salvar</button>
            </div>
        </div>
    </div>

    <!-- SDKs do Firebase -->
    <script type="module">
        // --- M√ìDULO DE INICIALIZA√á√ÉO E L√ìGICA PRINCIPAL ---

        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, limit, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Vari√°veis Globais e Constantes ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Elementos da UI
        const mainMenu = document.getElementById('main-menu');
        const rankingScreen = document.getElementById('ranking-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const nameModal = document.getElementById('name-modal');
        const rankingList = document.getElementById('ranking-list');
        // Adicione outros elementos de UI aqui...

        // Estado do Firebase
        let auth, db, userId, userPlayerName;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Estado do Jogo
        let player, items, score, lives, gameOver, gameLoopId;
        let highScore = 0, totalMilk = 0;
        let gameMode = 'infinite';
        
        // --- L√≥gica do Firebase e Ranking ---

        /**
         * Inicializa o Firebase e a autentica√ß√£o do usu√°rio.
         */
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usu√°rio autenticado:", userId);
                        await loadUserData(); // Carrega dados locais e do Firestore
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                rankingList.innerHTML = '<li>Erro ao conectar ao ranking.</li>';
            }
        }
        
        /**
         * Carrega os dados do usu√°rio (recorde, nome) do localStorage e Firestore.
         */
        async function loadUserData() {
            // Carrega dados locais primeiro para uma UI r√°pida
            highScore = parseInt(localStorage.getItem('leiteMachoHighScore') || '0', 10);
            totalMilk = parseInt(localStorage.getItem('leiteMachoTotalMilk') || '0', 10);
            userPlayerName = localStorage.getItem('leiteMachoPlayerName');
            updateUIDisplays();
            
            if (!db || !userId) return;

            // Busca o documento do usu√°rio no Firestore para sincronizar o recorde e nome
            const userDocRef = doc(db, `artifacts/${appId}/public/data/scores`, userId);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                // O recorde do Firestore √© a fonte da verdade
                highScore = data.score || highScore;
                // Se o nome existe no Firestore, ele tem preced√™ncia
                if(data.playerName) {
                    userPlayerName = data.playerName;
                }
                saveLocalData(); // Salva os dados sincronizados localmente
            }
            updateUIDisplays();
        }

        /**
         * Salva o recorde do jogador no Firestore.
         * @param {number} newScore A pontua√ß√£o final da partida.
         */
        async function saveScoreToLeaderboard(newScore) {
            if (!db || !userId || newScore <= highScore) {
                return; // N√£o salva se a pontua√ß√£o n√£o for maior ou se n√£o houver conex√£o
            }
            
            console.log(`Novo recorde! Salvando ${newScore} para ${userId}`);
            highScore = newScore; // Atualiza o recorde localmente
            
            const playerDocRef = doc(db, `artifacts/${appId}/public/data/scores`, userId);
            const dataToSave = {
                score: highScore,
                playerName: userPlayerName || `Jogador_${userId.substring(0, 5)}`,
                timestamp: new Date()
            };

            try {
                await setDoc(playerDocRef, dataToSave, { merge: true });
                console.log("Recorde salvo no Firestore!");
                // Ap√≥s salvar, verifica se o jogador precisa inserir um nome
                if (!userPlayerName) {
                    nameModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao salvar recorde:", error);
            }
        }

        /**
         * Busca e exibe o ranking global.
         */
        async function fetchAndDisplayLeaderboard() {
            showScreen(rankingScreen);
            rankingList.innerHTML = '<li class="loading">Carregando ranking...</li>';
            if (!db) return;

            try {
                const scoresRef = collection(db, `artifacts/${appId}/public/data/scores`);
                // Firestore n√£o permite `orderBy` sem um √≠ndice composto, ent√£o vamos buscar e ordenar no cliente.
                // Isso √© vi√°vel para um n√∫mero moderado de jogadores.
                const querySnapshot = await getDocs(scoresRef);
                
                let scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena por pontua√ß√£o (maior primeiro)
                scores.sort((a, b) => (b.score || 0) - (a.score || 0));

                // Limita aos top 100
                const topScores = scores.slice(0, 100);

                rankingList.innerHTML = ''; // Limpa a lista
                if (topScores.length === 0) {
                    rankingList.innerHTML = '<li>Ningu√©m no ranking ainda. Seja o primeiro!</li>';
                    return;
                }

                topScores.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="rank">#${index + 1}</span>
                        <span class="name">${escapeHTML(entry.playerName || 'An√¥nimo')}</span>
                        <span class="score">${entry.score}</span>
                    `;
                    if (entry.id === userId) {
                        li.style.backgroundColor = 'rgba(255, 222, 89, 0.2)';
                        li.style.border = '1px solid var(--primary-yellow)';
                    }
                    rankingList.appendChild(li);
                });

            } catch (error) {
                console.error("Erro ao buscar ranking:", error);
                rankingList.innerHTML = '<li>N√£o foi poss√≠vel carregar o ranking.</li>';
            }
        }
        
        /**
         * Salva os dados do jogador localmente.
         */
        function saveLocalData() {
            localStorage.setItem('leiteMachoHighScore', highScore);
            localStorage.setItem('leiteMachoTotalMilk', totalMilk);
            if (userPlayerName) {
                localStorage.setItem('leiteMachoPlayerName', userPlayerName);
            }
        }
        
        /**
         * Atualiza os displays da UI com os dados atuais.
         */
        function updateUIDisplays() {
            document.querySelectorAll('.high-score').forEach(el => el.textContent = `Seu Recorde: ${highScore}`);
            document.querySelectorAll('.total-milk-display').forEach(el => el.textContent = `Leite Total: ${totalMilk}`);
        }

        /**
         * Salva o nome do jogador localmente e no Firestore.
         */
        async function savePlayerName() {
            const input = document.getElementById('player-name-input');
            const newName = input.value.trim();
            if (newName && newName.length > 2) {
                userPlayerName = newName;
                saveLocalData(); // Salva localmente
                nameModal.classList.add('hidden');

                // Atualiza o nome no Firestore
                if (db && userId) {
                    const playerDocRef = doc(db, `artifacts/${appId}/public/data/scores`, userId);
                    try {
                        await setDoc(playerDocRef, { playerName: userPlayerName }, { merge: true });
                    } catch (error) {
                         console.error("Erro ao atualizar nome no Firestore:", error);
                    }
                }
            } else {
                alert("Por favor, insira um nome com pelo menos 3 caracteres.");
            }
        }
        
        // --- L√≥gica Principal do Jogo (Simplificada para o exemplo) ---
        
        function initGame(mode) {
            gameMode = mode;
            score = 0; lives = 3; gameOver = false;
            // Resetar outras vari√°veis de jogo...
            
            showScreen(null); // Esconde todos os menus para mostrar o canvas
            
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoop();
        }

        function gameLoop() {
            if (gameOver) return;
            // L√≥gica de update e draw do jogo aqui...
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = '24px Fredoka One';
            ctx.textAlign = 'center';
            ctx.fillText(`Pontos: ${score}`, canvas.width / 2, 50);
            
            // Simula√ß√£o de fim de jogo
            if(score > 100 + Math.random() * 200) {
               endGame();
               return;
            }
            score++;
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        async function endGame() {
            gameOver = true;
            cancelAnimationFrame(gameLoopId);
            
            totalMilk += score;
            document.getElementById('final-score').textContent = `Sua pontua√ß√£o: ${score}`;
            
            if (score > highScore) {
                await saveScoreToLeaderboard(score);
            }
            
            saveLocalData();
            updateUIDisplays();
            showScreen(gameOverScreen);
        }
        
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            if(screen) screen.classList.remove('hidden');
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.querySelector('button[data-mode="infinite"]').addEventListener('click', () => initGame('infinite'));
            document.getElementById('ranking-button').addEventListener('click', fetchAndDisplayLeaderboard);
            document.getElementById('restart-button').addEventListener('click', () => initGame(gameMode));
            document.getElementById('save-name-button').addEventListener('click', savePlayerName);
            document.querySelectorAll('.back-to-menu-button').forEach(btn => {
                btn.addEventListener('click', () => showScreen(mainMenu));
            });
            window.addEventListener('resize', () => { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; });
        }

        // --- Ponto de Entrada ---
        function main() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            setupEventListeners();
            initFirebase(); // Inicia a conex√£o com o backend
            showScreen(mainMenu); // Mostra o menu principal
        }

        main();
    </script>
</body>
</html>
